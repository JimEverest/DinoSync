# 获取笔记列表（同步接口）

## 接口概述

这是 Dinox 的核心同步接口，用于获取用户的笔记列表。支持增量同步（通过 `lastSyncTime` 参数），并且服务器端会根据提供的模板来渲染笔记内容。

**特点**：
- ✅ 支持增量同步
- ✅ 服务器端模板渲染
- ✅ 按日期分组返回
- ✅ 支持笔记删除标记
- ✅ 包含音频笔记信息

---

## OpenAPI Specification

```yaml
openapi: 3.0.1
info:
  title: Dinox API
  description: Dinox 笔记同步接口
  version: 5.0.0
paths:
  /openapi/v5/notes:
    post:
      summary: 获取笔记列表（支持增量同步）
      deprecated: false
      description: |
        获取用户的笔记列表，支持通过 lastSyncTime 进行增量同步。
        服务器会根据提供的 template 参数来渲染笔记内容，返回完整的 Markdown 格式内容。
      tags:
        - 笔记同步
      parameters:
        - name: Authorization
          in: header
          description: API Token（JWT格式）
          required: true
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                noteId:
                  type: integer
                  description: 固定值 0，表示获取所有笔记
                  example: 0
                lastSyncTime:
                  type: string
                  format: date-time
                  description: |
                    上次同步时间，格式：YYYY-MM-DD HH:mm:ss
                    首次同步或重置后使用：1900-01-01 00:00:00
                  example: "1900-01-01 00:00:00"
                template:
                  type: string
                  description: |
                    Mustache/Handlebars 格式的模板字符串，用于服务器端渲染笔记内容。
                    模板中可用的变量包括：
                    - {{title}}: 笔记标题
                    - {{noteId}}: 笔记唯一ID
                    - {{type}}: 笔记类型
                    - {{tags}}: 标签数组
                    - {{zettelBoxes}}: 卡片盒数组
                    - {{audioUrl}}: 音频URL
                    - {{createTime}}: 创建时间
                    - {{updateTime}}: 更新时间
                    - {{content}}: 笔记正文内容
                  example: |
                    ---
                    title: {{title}}
                    noteId: {{noteId}}
                    type: {{type}}
                    tags:
                    {{#tags}}
                        - {{.}}
                    {{/tags}}
                    zettelBoxes:
                    {{#zettelBoxes}}
                        - {{.}}
                    {{/zettelBoxes}}
                    audioUrl: {{audioUrl}}
                    createTime: {{createTime}}
                    updateTime: {{updateTime}}
                    ---
                    {{#audioUrl}}
                    ![录音]({{audioUrl}})
                    {{/audioUrl}}

                    {{content}}
              required:
                - noteId
                - lastSyncTime
                - template
            example:
              noteId: 0
              lastSyncTime: "1900-01-01 00:00:00"
              template: "---\ntitle: {{title}}\nnoteId: {{noteId}}\ntype: {{type}}\ntags:\n{{#tags}}\n    - {{.}}\n{{/tags}}\nzettelBoxes:\n{{#zettelBoxes}}\n    - {{.}}\n{{/zettelBoxes}}\naudioUrl: {{audioUrl}}\ncreateTime: {{createTime}}\nupdateTime: {{updateTime}}\n---\n{{#audioUrl}}\n![录音]({{audioUrl}})\n{{/audioUrl}}\n\n{{content}}\n"
      responses:
        '200':
          description: 成功返回笔记列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: string
                    description: 返回码，"000000" 表示成功
                    example: "000000"
                  msg:
                    type: string
                    description: 返回消息
                    example: "ok"
                  data:
                    type: array
                    description: 按日期分组的笔记列表
                    items:
                      type: object
                      properties:
                        date:
                          type: string
                          format: date
                          description: 日期，格式：YYYY-MM-DD
                          example: "2025-10-18"
                        notes:
                          type: array
                          description: 该日期下的笔记列表
                          items:
                            type: object
                            properties:
                              title:
                                type: string
                                description: 笔记标题
                              createTime:
                                type: string
                                format: date-time
                                description: 创建时间
                              content:
                                type: string
                                description: 根据模板渲染后的完整内容（包含 frontmatter）
                              noteId:
                                type: string
                                format: uuid
                                description: 笔记唯一ID（UUID格式）
                              tags:
                                type: array
                                items:
                                  type: string
                                description: 标签列表
                              type:
                                type: string
                                description: 笔记类型
                                example: "note"
                              contentMd:
                                type: string
                                description: 纯正文内容（不含 frontmatter）
                              updateTime:
                                type: string
                                format: date-time
                                description: 更新时间
                              audioDetail:
                                type: object
                                description: 音频详情（如果是音频笔记）
                                properties:
                                  remote:
                                    type: string
                                    nullable: true
                                    description: OSS 远程音频URL
                                  resourceId:
                                    type: string
                                    nullable: true
                                    description: 资源ID
                                  summary:
                                    type: string
                                    nullable: true
                                    description: 音频摘要
                                  type:
                                    type: string
                                    nullable: true
                                    description: 音频类型
                                  local:
                                    type: string
                                    nullable: true
                                    description: 本地文件路径
                                  length:
                                    type: integer
                                    nullable: true
                                    description: 音频时长（秒）
                                  segments:
                                    type: array
                                    nullable: true
                                    description: 音频片段信息
                              isDel:
                                type: boolean
                                description: 是否已删除标记
                              zettelBoxes:
                                type: array
                                items:
                                  type: string
                                description: 卡片盒列表
      security: []
components:
  schemas: {}
  securitySchemes: {}
servers:
  - url: https://dinoai.chatgo.pro
    description: 生产环境
security: []
```

---

## 请求示例

### cURL 请求

```bash
curl -X POST https://dinoai.chatgo.pro/openapi/v5/notes \
  -H "Content-Type: application/json" \
  -H "Authorization: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -d '{
    "noteId": 0,
    "lastSyncTime": "1900-01-01 00:00:00",
    "template": "---\ntitle: {{title}}\nnoteId: {{noteId}}\ntype: {{type}}\ntags:\n{{#tags}}\n    - {{.}}\n{{/tags}}\nzettelBoxes:\n{{#zettelBoxes}}\n    - {{.}}\n{{/zettelBoxes}}\naudioUrl: {{audioUrl}}\ncreateTime: {{createTime}}\nupdateTime: {{updateTime}}\n---\n{{#audioUrl}}\n![录音]({{audioUrl}})\n{{/audioUrl}}\n\n{{content}}\n"
  }'
```

### JavaScript (Node.js) 请求

```javascript
const https = require('https');

const requestBody = JSON.stringify({
    noteId: 0,
    lastSyncTime: "1900-01-01 00:00:00",
    template: `---
title: {{title}}
noteId: {{noteId}}
type: {{type}}
tags:
{{#tags}}
    - {{.}}
{{/tags}}
zettelBoxes:
{{#zettelBoxes}}
    - {{.}}
{{/zettelBoxes}}
audioUrl: {{audioUrl}}
createTime: {{createTime}}
updateTime: {{updateTime}}
---
{{#audioUrl}}
![录音]({{audioUrl}})
{{/audioUrl}}

{{content}}
`
});

const options = {
    hostname: 'dinoai.chatgo.pro',
    path: '/openapi/v5/notes',
    method: 'POST',
    headers: {
        'Authorization': 'YOUR_TOKEN_HERE',
        'Content-Type': 'application/json',
        'Content-Length': Buffer.byteLength(requestBody)
    }
};

const req = https.request(options, (res) => {
    let data = '';
    res.on('data', (chunk) => data += chunk);
    res.on('end', () => {
        const result = JSON.parse(data);
        console.log(result);
    });
});

req.write(requestBody);
req.end();
```

### Insomnia / Postman 请求体

在 Insomnia 或 Postman 中使用时，请确保：
1. **Content-Type**: `application/json`
2. **Authorization Header**: 添加你的 Token
3. **请求体格式**：使用正确的 JSON 格式（注意换行符需要用 `\n` 转义）

```json
{
  "noteId": 0,
  "lastSyncTime": "1900-01-01 00:00:00",
  "template": "---\ntitle: {{title}}\nnoteId: {{noteId}}\ntype: {{type}}\ntags:\n{{#tags}}\n    - {{.}}\n{{/tags}}\nzettelBoxes:\n{{#zettelBoxes}}\n    - {{.}}\n{{/zettelBoxes}}\naudioUrl: {{audioUrl}}\ncreateTime: {{createTime}}\nupdateTime: {{updateTime}}\n---\n{{#audioUrl}}\n![录音]({{audioUrl}})\n{{/audioUrl}}\n\n{{content}}\n"
}
```

---

## 响应示例

### 成功响应

详见 [list response example.json](./list%20response%20example.json) 文件，包含完整的响应结构示例。

**响应结构概览**：

```json
{
  "code": "000000",
  "msg": "ok",
  "data": [
    {
      "date": "2025-10-18",
      "notes": [
        {
          "title": "工作中的冲突与加班情况",
          "createTime": "2025-10-18 17:05:15",
          "content": "---\ntitle: 工作中的冲突与加班情况\nnoteId: 0199f690-e80b-73ed-b2dd-2f13c2edece9\n...",
          "noteId": "0199f690-e80b-73ed-b2dd-2f13c2edece9",
          "tags": [],
          "type": "note",
          "contentMd": "对，他说要下班了...",
          "updateTime": "2025-10-18 17:09:25",
          "audioDetail": {
            "remote": "https://dinoai.oss-accelerate.aliyuncs.com/...",
            "length": 238
          },
          "isDel": false,
          "zettelBoxes": []
        }
      ]
    },
    {
      "date": "2025-10-17",
      "notes": [...]
    }
  ]
}
```

### 错误响应

```json
{
  "code": "400001",
  "msg": "Token 无效或已过期",
  "data": null
}
```

---

## 重要说明

### 1. 增量同步机制

- **首次同步**：使用 `lastSyncTime: "1900-01-01 00:00:00"` 获取所有笔记
- **增量同步**：使用上次同步成功的时间戳，只获取该时间后更新的笔记
- **重置同步**：如果需要重新获取所有笔记，将 `lastSyncTime` 重置为 `"1900-01-01 00:00:00"`

### 2. 模板渲染

- 模板在**服务器端**应用，返回的 `content` 字段已经是渲染后的完整内容
- 使用 Mustache/Handlebars 语法
- 建议包含 frontmatter 以便在 Obsidian 等工具中更好地管理元数据

### 3. 删除处理

- `isDel: true` 表示该笔记已被删除
- 客户端应该删除本地对应的笔记文件
- 删除的笔记 `content` 和 `contentMd` 字段为空字符串

### 4. 音频笔记

- 音频笔记的 `audioDetail.remote` 包含 OSS 音频文件 URL
- `audioDetail.length` 表示音频时长（秒）
- 可以在模板中使用 `{{audioUrl}}` 引用音频链接

### 5. 返回码说明

| 返回码 | 说明 |
|--------|------|
| 000000 | 成功 |
| 400001 | Token 无效或已过期 |
| 400002 | 参数错误 |
| 500000 | 服务器内部错误 |

### 6. 性能建议

- 定期进行增量同步（建议间隔：30分钟）
- 首次同步可能返回大量数据，建议做好进度提示
- 建议客户端保存 `lastSyncTime` 以支持增量同步

### 7. 注意事项

- ⚠️ Token 需要妥善保管，不要泄露
- ⚠️ 模板字符串中的换行符必须使用 `\n` 转义（在 JSON 中）
- ⚠️ `noteId` 参数固定为 `0`，表示获取所有笔记
- ⚠️ 时间格式必须严格遵循 `YYYY-MM-DD HH:mm:ss`

---

## 完整集成示例

### Obsidian 插件集成示例

参考 [main.ts](../main.ts) 中的实现：

```typescript
async fetchNotesFromApi(lastSyncTime: string): Promise<DayNote[]> {
    const requestBody = JSON.stringify({
        template: this.settings.template,
        noteId: 0,
        lastSyncTime: lastSyncTime,
    });

    const resp = await requestUrl({
        url: `${API_BASE_URL}/openapi/v5/notes`,
        method: "POST",
        headers: {
            Authorization: this.settings.token,
            "Content-Type": "application/json",
        },
        body: requestBody,
    });

    if (resp.status !== 200) {
        throw new Error(`API HTTP Error: Status ${resp.status}`);
    }

    const result = resp.json as GetNoteApiResult;

    if (result.code !== "000000") {
        throw new Error(`API Logic Error: Code ${result.code}`);
    }

    return result.data || [];
}
```

---

## 相关文档

- [根据 ID 查询笔记](./根据%20id%20查询笔记.md)
- [根据关键词查询笔记](./根据关键词查询笔记.md)
- [创建笔记](./创建笔记.md)
- [创建笔记 含标题 & tag](./创建笔记%20含标题%20%26%20tag.md)

---

## 更新日志

- **v5.0.0** (2024-10-18)
  - 支持服务器端模板渲染
  - 优化增量同步性能
  - 增加音频笔记支持

---

## 技术支持

如有问题，请联系：
- **Email**: zmyjust@gmail.com
- **GitHub Issues**: [dinox-sync](https://github.com/ryzencool/dinox-sync/issues)
- **官网**: https://dinox.info

